<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.miracle.dao.ChildrenQueryDAO">

	<!-- <cache /> -->
	
	<resultMap id="peopleVOMap" type="PeopleVO">
		<result property="id" column="ID" />
		<result property="name" column="NAME" />
		<result property="gender" column="GENDER" />
		<result property="birthday" column="BIRTHDAY" />
		<result property="school" column="SCHOOL" />
		<result property="grade" column="GRADE" />
		<result property="groupName" column="GROUP_NAME" />
		<result property="groupLeader" column="GROUP_LEADER" />
		<result property="worshipName" column="WORSHIP_NAME" />
		<result property="careWeekday" column="CARE_WEEKDAY" />
		<result property="caretStime" column="CARE_STIME" />
		<result property="caretEtime" column="CARE_ETIME" />
	</resultMap>
	
	<resultMap id="contactMap" type="Contact">
		<result property="name" column="NAME" />
		<result property="tel1" column="TEL1" />
		<result property="tel2" column="TEL2" />
		<result property="addr" column="ADDR" />
	</resultMap>
	
	<resultMap id="careTimeMap" type="CareTime">
		<result property="weekDay" column="WEEKDAY" />
		<result property="stime" column="STIME" />
		<result property="etime" column="ETIME" />
	</resultMap>
	
	<resultMap id="presentWorshipVOMap" type="PresentWorshipVO">
		<result property="pid" column="PID" />
		<result property="chkinTime" column="CHKIN_TIME" />
		<result property="worshipName" column="WORSHIP_NAME" />
		<result property="note" column="NOTE" />
	</resultMap>
	
	<resultMap id="statementVOMap" type="Statement">
		<result property="createName" column="CREATE_NAME" />
		<result property="statement" column="STATEMENT" />
		<result property="create" column="CREATE_TIME" />
		<result property="lastUpdate" column="LAST_UPDATE" />
		<result property="note" column="NOTE" />
	</resultMap>
	
	<resultMap id="presentWorshipMap" type="PresentWorship">
		<result property="id" column="ID" />
	</resultMap>


	<select id="findPeopleData" parameterType="string" resultMap="peopleVOMap">
		select A.ID, A.NAME, A.GENDER, A.SCHOOL, A.GRADE,
		       UNIX_TIMESTAMP(A.BIRTHDAY) BIRTHDAY,
		       B.NAME AS GROUP_NAME, B.LEADER AS GROUP_LEADER, C.NAME AS WORSHIP_NAME,
		       D.WEEKDAY AS CARE_WEEKDAY, D.STIME AS CARE_STIME, D.ETIME AS CARE_ETIME
		from people A
		left join PEOPLE_GROUP B on A.GROUP = B.ID
		left join WORSHIP C on A.WORSHIP = C.ID
		left join CARE_TIME D on A.ID = D.PID 
		where A.ID = #{peopleId}
	</select>
	
	<select id="findContact" parameterType="string" resultMap="contactMap">
		select NAME, TEL1, TEL2, ADDR
		from CONTACT
		where PID = #{peopleId}
	</select>
	
	<select id="findCareTime" parameterType="string" resultMap="careTimeMap">
		select PID, WEEKDAY, STIME, ETIME
		from care_time
		where PID = #{peopleId}
	</select>
	
	<select id="findPresentWorship" parameterType="string" resultMap="presentWorshipVOMap">
		select A.PID, UNIX_TIMESTAMP(A.CHKIN_TIME) AS CHKIN_TIME, B.NAME as WORSHIP_NAME, A.NOTE
		from present_worship A
		left join worship B on A.ACTIVITY_ID = B.ID
		WHERE A.PID = #{peopleId}
	</select>
	
	<select id="findStatementAll" parameterType="string" resultMap="statementVOMap">
		select B.NAME as CREATE_NAME, A.STATEMENT, UNIX_TIMESTAMP(A.CREATE) AS CREATE_TIME,
		       UNIX_TIMESTAMP(A.LAST_UPDATE) AS LAST_UPDATE, A.NOTE
		from statement A
		left join people B on A.ID = B.ID
		WHERE A.ID = #{peopleId}
	</select>
	
	<select id="findPresentWorshipByKey" parameterType="presentWorship" resultType="string">
		select ID
		from present_worship
		WHERE CID = #{cid}
		  and PID = #{pid}
		  and ACTIVITY_ID = #{activityId}
		  and to_days(CHKIN_TIME) = to_days(now())
	</select>
	
	<!-- <select id="findWorshipIdByKey" parameterType="presentWorship" resultType="string">
		select B.ID from worship B
		where B.WEEKDAY = DAYOFWEEK(NOW()) 
		and DATE_FORMAT(NOW(),'%H%i') BETWEEN B.START_CHECKIN AND B.STOP_CHECKIN
		and B.EDU = (select EDU from people where ID = #{peopleId})
	</select> -->
	

</mapper>
